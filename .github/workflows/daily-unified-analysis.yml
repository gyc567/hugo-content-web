name: Daily Analysis - Unified

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6:00è¿è¡Œï¼ˆUTC 22:00å‰ä¸€å¤©ï¼‰
    - cron: '0 22 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  unified-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™ä»“åº“å†…å®¹
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        timeout-minutes: 10
        run: |
          echo "ðŸ“¦ å®‰è£… Python ä¾èµ–..."
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          pip install beautifulsoup4 lxml  # Product Huntåˆ†æžéœ€è¦çš„é¢å¤–ä¾èµ–
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Check Python syntax
        run: |
          echo "ðŸ” æ£€æŸ¥Pythonè¯­æ³•..."
          python -m py_compile scripts/crypto-project-analyzer.py
          python -m py_compile scripts/claude_prompts_analyzer.py
          python -m py_compile scripts/producthunt_analyzer.py
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run Claude Agent Analysis
        id: claude_agent
        timeout-minutes: 25
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTIONS: true
          DAYS_BACK: 7
          MAX_PROJECTS: 3
        run: |
          echo "ðŸš€ å¼€å§‹è¿è¡ŒClaude Agentåˆ†æžå™¨..."
          cd ${{ github.workspace }}
          if ! python scripts/crypto-project-analyzer.py; then
            echo "âŒ Claude Agentåˆ†æžå™¨è¿è¡Œå¤±è´¥"
            echo "claude_agent_success=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Claude Agentåˆ†æžå™¨è¿è¡ŒæˆåŠŸ"
            echo "claude_agent_success=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Prompts Analysis
        id: claude_prompts
        timeout-minutes: 25
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTIONS: true
          DAYS_BACK: 7
          MAX_PROJECTS: 3
        run: |
          echo "ðŸš€ å¼€å§‹è¿è¡ŒClaude Promptsåˆ†æžå™¨..."
          cd ${{ github.workspace }}
          if ! python scripts/claude_prompts_analyzer.py; then
            echo "âŒ Claude Promptsåˆ†æžå™¨è¿è¡Œå¤±è´¥"
            echo "claude_prompts_success=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Claude Promptsåˆ†æžå™¨è¿è¡ŒæˆåŠŸ"
            echo "claude_prompts_success=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Product Hunt Analysis
        id: producthunt
        timeout-minutes: 25
        continue-on-error: true
        env:
          GITHUB_ACTIONS: true
        run: |
          echo "ðŸš€ å¼€å§‹è¿è¡ŒProduct Huntåˆ†æžå™¨..."
          cd ${{ github.workspace }}
          if ! python scripts/producthunt_analyzer.py; then
            echo "âŒ Product Huntåˆ†æžå™¨è¿è¡Œå¤±è´¥"
            echo "producthunt_success=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Product Huntåˆ†æžå™¨è¿è¡ŒæˆåŠŸ"
            echo "producthunt_success=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for new articles
        id: check_articles
        run: |
          TODAY=$(date +%Y-%m-%d)
          CLAUDE_AGENT_ARTICLES=$(find content/posts -name "*$(date +%Y-%m-%d)*" -name "*claude-agent*" -type f | wc -l)
          CLAUDE_PROMPTS_ARTICLES=$(find content/posts -name "*$(date +%Y-%m-%d)*" -name "*claude-prompts*" -type f | wc -l)
          PRODUCTHUNT_ARTICLES=$(find content/posts -name "*producthunt-top3*$(date +%Y-%m-%d)*" -type f | wc -l)
          
          TOTAL_ARTICLES=$((CLAUDE_AGENT_ARTICLES + CLAUDE_PROMPTS_ARTICLES + PRODUCTHUNT_ARTICLES))
          
          echo "claude_agent_articles=$CLAUDE_AGENT_ARTICLES" >> $GITHUB_OUTPUT
          echo "claude_prompts_articles=$CLAUDE_PROMPTS_ARTICLES" >> $GITHUB_OUTPUT
          echo "producthunt_articles=$PRODUCTHUNT_ARTICLES" >> $GITHUB_OUTPUT
          echo "total_articles=$TOTAL_ARTICLES" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š ä»Šæ—¥æ–‡ç« ç»Ÿè®¡:"
          echo "  - Claude Agent: $CLAUDE_AGENT_ARTICLES ç¯‡"
          echo "  - Claude Prompts: $CLAUDE_PROMPTS_ARTICLES ç¯‡"
          echo "  - Product Hunt: $PRODUCTHUNT_ARTICLES ç¯‡"
          echo "  - æ€»è®¡: $TOTAL_ARTICLES ç¯‡"

      - name: Build Hugo site
        if: steps.check_articles.outputs.total_articles > 0
        timeout-minutes: 10
        run: |
          echo "ðŸ—ï¸ æž„å»º Hugo ç«™ç‚¹..."
          hugo --cleanDestinationDir --minify
          echo "âœ… ç«™ç‚¹æž„å»ºå®Œæˆ"

      - name: Commit and push changes
        if: steps.check_articles.outputs.total_articles > 0
        run: |
          git add .
          if ! git diff --staged --quiet; then
            COMMIT_MSG="ðŸ¤– Auto: Daily unified analysis $(date +%Y-%m-%d) - ${{ steps.check_articles.outputs.total_articles }} articles"$'\n\n'"ðŸ¤– Generated with [Claude Code](https://claude.ai/code)"$'\n\n'"Co-Authored-By: Claude <noreply@anthropic.com>"
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… æ›´æ–°å·²æŽ¨é€åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Daily Unified Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time**: $(date +%H:%M:%S UTC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ¯ Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Claude Agent**: ${{ steps.claude_agent.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Claude Prompts**: ${{ steps.claude_prompts.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Product Hunt**: ${{ steps.producthunt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“„ Generated Articles" >> $GITHUB_STEP_SUMMARY
          echo "- **Claude Agent Articles**: ${{ steps.check_articles.outputs.claude_agent_articles }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Claude Prompts Articles**: ${{ steps.check_articles.outputs.claude_prompts_articles }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Product Hunt Articles**: ${{ steps.check_articles.outputs.producthunt_articles }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Articles**: ${{ steps.check_articles.outputs.total_articles }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_articles.outputs.total_articles }}" -gt 0 ]; then
            echo "### âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "Successfully generated and published ${{ steps.check_articles.outputs.total_articles }} articles today!" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“‹ Article List" >> $GITHUB_STEP_SUMMARY
            find content/posts -name "*$(date +%Y-%m-%d)*" -type f -exec basename {} \; | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No New Articles" >> $GITHUB_STEP_SUMMARY
            echo "No new articles were generated today. This might be normal if all recent projects have already been analyzed." >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ˜¾ç¤ºåŽ†å²ç»Ÿè®¡
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Historical Statistics" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/analyzed_projects.json" ]; then
            TOTAL_PROJECTS=$(python3 -c "import json; print(json.load(open('data/analyzed_projects.json'))['total_projects'])" 2>/dev/null || echo "0")
            echo "- **Total Claude Agent Projects**: $TOTAL_PROJECTS" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "data/claude_prompts_projects.json" ]; then
            TOTAL_PROMPTS=$(python3 -c "import json; print(json.load(open('data/claude_prompts_projects.json'))['total_projects'])" 2>/dev/null || echo "0")
            echo "- **Total Claude Prompts Projects**: $TOTAL_PROMPTS" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "data/producthunt_products.json" ]; then
            TOTAL_PRODUCTS=$(python3 -c "import json; print(json.load(open('data/producthunt_products.json'))['total_products'])" 2>/dev/null || echo "0")
            echo "- **Total Product Hunt Products**: $TOTAL_PRODUCTS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Optimization Achieved" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Runtime**: ~270 minutes/month (3 separate workflows)" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Runtime**: ~90 minutes/month (1 unified workflow)" >> $GITHUB_STEP_SUMMARY
          echo "- **Savings**: ~180 minutes/month (67% reduction)" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Frequency**: Once per day at 06:00 Beijing Time" >> $GITHUB_STEP_SUMMARY